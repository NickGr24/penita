# üîç MAIB Callback Debugging Guide

## –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:

- ‚úÖ HTTPS URLs –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ Callback endpoint –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- ‚úÖ –ü–ª–∞—Ç–µ–∂ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- ‚ùå Callback –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç MAIB

---

## üéØ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å:

### **–í–´ –ó–ê–í–ï–†–®–ò–õ–ò –û–ü–õ–ê–¢–£ –ù–ê MAIB?**

Callback –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **–¢–û–õ–¨–ö–û** –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫:
1. ‚úÖ –û—Ç–∫—Ä—ã–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É MAIB
2. ‚úÖ –í–≤–µ–ª–∏ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
3. ‚úÖ –ù–∞–∂–∞–ª–∏ "–û–ø–ª–∞—Ç–∏—Ç—å"
4. ‚úÖ –ü–æ–ª—É—á–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞)

**–ï—Å–ª–∏ –≤—ã –ø—Ä–æ—Å—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ–ª–∏ –∏ –∑–∞–∫—Ä—ã–ª–∏ - callback –ù–ï –ü–†–ò–î–Å–¢!**

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:

### 1. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï!)

–ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "ContinuƒÉ cƒÉtre platƒÉ":

- [ ] –ü–æ–ø–∞–ª–∏ –Ω–∞ `https://maib.ecommerce.md:21443/...` ?
- [ ] –£–≤–∏–¥–µ–ª–∏ —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞ –∫–∞—Ä—Ç—ã?
- [ ] –í–≤–µ–ª–∏ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã?
- [ ] –ù–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å"/"Pay"?
- [ ] –£–≤–∏–¥–µ–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞)?
- [ ] –ö—É–¥–∞ –≤–∞—Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏–ª–æ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã?

**–ï—Å–ª–∏ –ù–ï –∑–∞–≤–µ—Ä—à–∏–ª–∏ –æ–ø–ª–∞—Ç—É - callback –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥–µ—Ç!**

---

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç

**–°–ø—Ä–æ—Å–∏—Ç–µ —É MAIB:**
> "–ö–∞–∫–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã —è –º–æ–≥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è?"

–û–±—ã—á–Ω–æ:
- **–£—Å–ø–µ—à–Ω–∞—è**: `4111 1111 1111 1111`
- **–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω–∞—è**: `4000 0000 0000 0002`
- **CVV**: –ª—é–±–æ–π (123)
- **–°—Ä–æ–∫**: –ª—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞

---

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
# 1. Nginx access logs (–≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã)
sudo tail -100 /var/log/nginx/access.log | grep callback

# 2. Nginx error logs
sudo tail -100 /var/log/nginx/error.log

# 3. Django/Gunicorn logs
sudo journalctl -u gunicorn -n 100 --no-pager | grep -A5 -B5 "CALLBACK"

# 4. –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ supervisor
sudo tail -100 /var/log/supervisor/gunicorn-stderr.log
```

**–ß—Ç–æ –∏—Å–∫–∞—Ç—å:**

#### ‚úÖ –ï—Å–ª–∏ callback –ü–†–ò–®–ï–õ:
```
==================================================
MAIB CALLBACK RECEIVED!
Request method: POST
Content-Type: application/json
Remote IP: <MAIB IP>
Request body: {...}
==================================================
```

#### ‚ùå –ï—Å–ª–∏ callback –ù–ï –ü–†–ò–®–ï–õ:
- –í –ª–æ–≥–∞—Ö –Ω–∏—á–µ–≥–æ –Ω–µ –±—É–¥–µ—Ç
- –ó–Ω–∞—á–∏—Ç MAIB –≤–æ–æ–±—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å

---

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ firewall

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ firewall –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –æ—Ç MAIB:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ firewall
sudo ufw status

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ—Ä—Ç 443 –æ—Ç–∫—Ä—ã—Ç
sudo ufw allow 443/tcp

# –ò–ª–∏ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –¥—Ä—É–≥–æ–π firewall
sudo iptables -L -n
```

---

### 5. –¢–µ—Å—Ç callback URL –∏–∑–≤–Ω–µ

–° **–¥—Ä—É–≥–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞** (–Ω–µ —Å —Å–µ—Ä–≤–µ—Ä–∞!):

```bash
curl -X POST https://penitadreptului.md/payment/callback/ \
  -H "Content-Type: application/json" \
  -d '{"payId":"test","status":"OK"}' \
  -v
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```json
{"status": "error"}  ‚Üê –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! Endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç.
```

---

### 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Nginx –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç:

```bash
sudo cat /etc/nginx/sites-enabled/penita  # –∏–ª–∏ –≤–∞—à –∫–æ–Ω—Ñ–∏–≥
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```nginx
location /payment/callback/ {
    proxy_pass http://127.0.0.1:8000;  # –∏–ª–∏ gunicorn socket
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

---

## üîß –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

–Ø –¥–æ–±–∞–≤–∏–ª –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `payments/views.py`:

```python
# –¢–µ–ø–µ—Ä—å –∫–∞–∂–¥—ã–π callback –±—É–¥–µ—Ç –ø–∏—Å–∞—Ç—å –≤ –ª–æ–≥–∏:
==================================================
MAIB CALLBACK RECEIVED!
Request method: POST
Content-Type: application/json
Remote IP: 1.2.3.4
Request body: {...full data...}
==================================================
```

**–ß—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å:**
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /–ø—É—Ç—å/–∫/–ø—Ä–æ–µ–∫—Ç—É
git pull origin main
sudo systemctl restart gunicorn
```

---

## üìä –°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:

### –°—Ü–µ–Ω–∞—Ä–∏–π A: Callback –ü–†–ò–®–ï–õ (–≤ –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ)

–ï—Å–ª–∏ –≤ –ª–æ–≥–∞—Ö –µ—Å—Ç—å:
```
MAIB CALLBACK RECEIVED!
```

–ù–æ —Å—Ç–∞—Ç—É—Å –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `Parsed callback data` –≤ –ª–æ–≥–∞—Ö
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ signature validation
3. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –æ—à–∏–±–∫–∏ –≤ `process_callback`

---

### –°—Ü–µ–Ω–∞—Ä–∏–π B: Callback –ù–ï –ü–†–ò–®–ï–õ (–≤ –ª–æ–≥–∞—Ö –ø—É—Å—Ç–æ)

–ü—Ä–∏—á–∏–Ω—ã:
1. **–û–ø–ª–∞—Ç–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞** ‚Üê 95% —Å–ª—É—á–∞–µ–≤!
2. MAIB –Ω–µ –º–æ–∂–µ—Ç –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è (firewall)
3. MAIB –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL
4. MAIB –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç callback –≤ test mode (—É—Ç–æ—á–Ω–∏—Ç—å —É –Ω–∏—Ö)

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –æ–ø–ª–∞—Ç—É –¥–æ –∫–æ–Ω—Ü–∞
2. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–Ω–æ–≤–∞
4. –°–≤—è–∂–∏—Ç–µ—Å—å —Å MAIB Support

---

### –°—Ü–µ–Ω–∞—Ä–∏–π C: MAIB –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç callback –≤ test mode

**–°–ø—Ä–æ—Å–∏—Ç–µ —É MAIB:**
> "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ª–∏ callback –≤ test/sandbox —Ä–µ–∂–∏–º–µ?
> –ò–ª–∏ callback —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ production?"

–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç callbacks –≤ test mode!

---

## üÜò –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞

–ï—Å–ª–∏ callback –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç, –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é:

### –í Django Admin:

1. Payments ‚Üí Payment ‚Üí –Ω–∞–π–¥–∏—Ç–µ –ø–ª–∞—Ç–µ–∂
2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ payId (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ)
3. –î–æ–±–∞–≤—å—Ç–µ action "Check Status from MAIB"

### –ß–µ—Ä–µ–∑ API:

```python
# –í Django shell –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
from payments.models import Payment
from payments.services import MAIBPaymentService

payment = Payment.objects.get(pay_id='75a0af44-dc71-4ab3-8505-ed3bbf24323d')
service = MAIBPaymentService(test_mode=True)
status = service.get_payment_status(payment)

print("Status from MAIB:", status)

# –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å OK - –æ–±–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é
if status and status.get('status') == 'OK':
    payment.status = 'OK'
    payment.status_code = status.get('statusCode')
    payment.status_message = status.get('statusMessage')
    payment.paid_at = timezone.now()
    payment.save()
    print("Payment updated!")
```

---

## üìû –í–æ–ø—Ä–æ—Å—ã –¥–ª—è MAIB Support

–ï—Å–ª–∏ callback –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –¥–∞–∂–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã:

### Email –≤ MAIB:

```
Subject: Callback not received in test mode

BunƒÉ ziua,

I'm testing payment integration (Project ID: 9B9C19AE-DC32-4128-9249-16412CCD7E6B)
and callback is not being sent to my server.

Payment details:
- payId: 75a0af44-dc71-4ab3-8505-ed3bbf24323d
- orderId: 20017384-f338-420e-965c-866910e4696f
- callbackUrl: https://penitadreptului.md/payment/callback/
- Date: 2025-12-18 15:36

Questions:
1. Do you send callbacks in test/sandbox mode?
2. Can you check if callback was sent for this transaction?
3. Are there any restrictions on callback URLs?
4. What IP addresses do callbacks come from? (for firewall)

The callback endpoint is accessible:
curl -X POST https://penitadreptului.md/payment/callback/ ‚Üí works

Please advise.

Thank you,
[Your name]
```

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫-–ª–∏—Å—Ç:

- [ ] –ó–∞–≤–µ—Ä—à–∏–ª–∏ –æ–ø–ª–∞—Ç—É –Ω–∞ MAIB (–≤–≤–µ–ª–∏ –∫–∞—Ä—Ç—É, –Ω–∞–∂–∞–ª–∏ Pay)
- [ ] –û–±–Ω–æ–≤–∏–ª–∏ –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (`git pull`)
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª–∏ gunicorn
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª–∏ —á—Ç–æ endpoint –¥–æ—Å—Ç—É–ø–µ–Ω (curl test)
- [ ] –°–¥–µ–ª–∞–ª–∏ –Ω–æ–≤—É—é —Ç–µ—Å—Ç–æ–≤—É—é –æ–ø–ª–∞—Ç—É
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª–∏ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ (nginx + django)
- [ ] –ï—Å–ª–∏ callback –ø—Ä–∏—à–µ–ª - –ø—Ä–æ–≤–µ—Ä–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ
- [ ] –ï—Å–ª–∏ –Ω–µ –ø—Ä–∏—à–µ–ª - —Å–≤—è–∑–∞–ª–∏—Å—å —Å MAIB

---

## üéØ –°–∞–º–æ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ:

**–û–ø–ª–∞—Ç–∞ –Ω–µ –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!**

Callback –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **–¢–û–õ–¨–ö–û** –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
- –ù–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å"
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞

–ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É MAIB ‚â† –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞!

–ó–∞–≤–µ—Ä—à–∏—Ç–µ –æ–ø–ª–∞—Ç—É –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–Ω–æ–≤–∞! üöÄ
